# PRD: Contract Parser Extended
## Product Requirements Document

### Версия документа: 1.0
### Дата создания: 2024-12-19
### Статус: Готов к разработке/Реализован

---

## 1. Обзор продукта

### 1.1 Название продукта
**Contract Parser Extended** - Универсальная система автоматической обработки документов с интеграцией в CRM

### 1.2 Цель продукта
Автоматизация процесса обработки входящих документов (договоры, извещения, спецификации) через email с последующим извлечением ключевой информации и интеграцией в систему Bitrix24.

### 1.3 Целевая аудитория
- Юридические отделы компаний
- Отделы закупок и продаж
- Менеджеры по работе с документооборотом
- Компании, работающие с большим объемом входящих документов

---

## 2. Бизнес-требования

### 2.1 Проблема
- Ручная обработка входящих документов занимает много времени
- Высокий риск человеческих ошибок при извлечении данных
- Отсутствие автоматической интеграции с CRM системами
- Сложность классификации различных типов документов

### 2.2 Решение
Автоматизированная система, которая:
- Получает документы из email
- Классифицирует их по типам
- Извлекает текст из различных форматов
- Анализирует содержимое с помощью ИИ
- Интегрируется с Bitrix24 CRM

### 2.3 Ключевые метрики успеха
- Сокращение времени обработки документов на 80%
- Точность извлечения данных > 95%
- Автоматическая обработка 90% входящих документов
- Интеграция с CRM в режиме реального времени

---

## 3. Функциональные требования

### 3.1 Основные функции

#### 3.1.1 Получение документов
- **FR-001**: Система должна автоматически получать email с вложениями
- **FR-002**: Поддержка IMAP протокола для чтения почты
- **FR-003**: Фильтрация email по отправителям и темам
- **FR-004**: Сохранение вложений во временную папку

#### 3.1.2 Классификация документов
- **FR-005**: Автоматическая классификация документов по типам:
  - Договоры (.pdf, .doc, .docx)
  - Извещения (.doc, .docx, .txt)
  - Номенклатура/спецификации (.xls, .xlsx)
- **FR-006**: Возможность добавления новых типов документов
- **FR-007**: Обработка неизвестных типов документов

#### 3.1.3 Извлечение текста
- **FR-008**: Поддержка форматов: PDF, DOCX, XLSX, XLS, TXT
- **FR-009**: Универсальный интерфейс для всех типов файлов
- **FR-010**: Обработка поврежденных или защищенных файлов
- **FR-011**: Сохранение метаданных файлов

#### 3.1.4 ИИ-анализ содержимого
- **FR-012**: Извлечение ключевых условий из договоров:
  - Стороны договора
  - Предмет договора
  - Сроки исполнения
  - Стоимость
  - Условия оплаты
- **FR-013**: Извлечение таблиц номенклатуры:
  - Наименование товара/услуги
  - Количество
  - Единица измерения
  - Цена
  - Сумма
- **FR-014**: Структурированный вывод в JSON формате

#### 3.1.5 Интеграция с CRM
- **FR-015**: Отправка данных в Bitrix24 через webhook
- **FR-016**: Создание лидов с извлеченной информацией
- **FR-017**: Прикрепление исходных документов к записям CRM
- **FR-018**: Обработка ошибок интеграции

### 3.2 Дополнительные функции

#### 3.2.1 Планировщик задач
- **FR-019**: Автоматический запуск по расписанию
- **FR-020**: Настройка интервалов проверки почты
- **FR-021**: Логирование всех операций

#### 3.2.2 Демо-режим
- **FR-022**: Работа без API ключей с заглушками
- **FR-023**: Тестовые данные для демонстрации
- **FR-024**: Валидация настроек перед запуском

---

## 4. Нефункциональные требования

### 4.1 Производительность
- **NFR-001**: Обработка документа размером до 10MB за < 30 секунд
- **NFR-002**: Поддержка одновременной обработки до 10 документов
- **NFR-003**: Время отклика API < 5 секунд

### 4.2 Надежность
- **NFR-004**: Доступность системы 99.5%
- **NFR-005**: Автоматическое восстановление после сбоев
- **NFR-006**: Резервное копирование обработанных данных

### 4.3 Безопасность
- **NFR-007**: Шифрование паролей и API ключей
- **NFR-008**: Безопасное хранение временных файлов
- **NFR-009**: Логирование всех операций доступа
- **NFR-010**: Автоматическое удаление временных файлов

### 4.4 Совместимость
- **NFR-011**: Поддержка Windows 10/11
- **NFR-012**: Python 3.8+
- **NFR-013**: Совместимость с OpenAI API v1.0+
- **NFR-014**: Интеграция с Bitrix24 REST API

---

## 5. Техническая архитектура

### 5.1 Компоненты системы

#### 5.1.1 Модуль чтения email (`email_reader.py`)
- Подключение к IMAP серверу
- Получение новых сообщений
- Скачивание вложений

#### 5.1.2 Модуль классификации (`preprocessing/`)
- Определение типа документа
- Маршрутизация для дальнейшей обработки

#### 5.1.3 Модуль извлечения текста (`ingestion/`)
- Универсальный интерфейс для разных форматов
- Обработка ошибок чтения файлов

#### 5.1.4 Модуль ИИ-анализа (`llm/`)
- Интеграция с OpenAI GPT-4
- Структурированное извлечение данных
- Демо-режим для тестирования

#### 5.1.5 Модуль интеграции CRM (`bitrix24/`)
- Отправка данных через webhook
- Обработка ответов API

#### 5.1.6 Основной модуль (`main/`)
- Оркестрация всех компонентов
- Обработка ошибок
- Сохранение результатов

### 5.2 Зависимости
```
openai>=1.0.0
requests>=2.25.0
python-docx>=0.8.11
pdfplumber>=0.7.0
openpyxl>=3.0.9
xlrd>=2.0.1
python-dotenv>=0.19.0
schedule>=1.1.0
```

---

## 6. Пользовательские сценарии

### 6.1 Сценарий 1: Обработка договора
1. Пользователь отправляет договор на email
2. Система получает письмо и скачивает вложение
3. Документ классифицируется как "договор"
4. Извлекается текст из PDF
5. ИИ анализирует и извлекает ключевые условия
6. Данные отправляются в Bitrix24
7. Создается лид с информацией о договоре

### 6.2 Сценарий 2: Обработка спецификации
1. Получение Excel файла со спецификацией
2. Классификация как "номенклатура"
3. Извлечение данных из таблиц
4. ИИ структурирует информацию о товарах
5. Создание записей в CRM с таблицей товаров

### 6.3 Сценарий 3: Демо-режим
1. Запуск без настроенных API ключей
2. Обработка тестовых документов
3. Получение демо-данных вместо реального ИИ-анализа
4. Валидация работы всех компонентов

---

## 7. Интерфейсы

### 7.1 Конфигурационные файлы
- `.env` - переменные окружения
- `requirements.txt` - зависимости Python
- `.gitignore` - исключения для Git

### 7.2 Входные данные
- Email с вложениями (PDF, DOCX, XLSX, XLS, TXT)
- Конфигурация подключений (IMAP, OpenAI, Bitrix24)

### 7.3 Выходные данные
- JSON файлы с результатами анализа
- Записи в Bitrix24 CRM
- Логи операций

---

## 8. Ограничения и допущения

### 8.1 Ограничения
- Максимальный размер файла: 10MB
- Поддерживаемые языки: русский, английский
- Требуется подключение к интернету для ИИ-анализа
- Зависимость от внешних API (OpenAI, Bitrix24)

### 8.2 Допущения
- Документы имеют стандартную структуру
- Email сервер поддерживает IMAP
- Bitrix24 webhook настроен корректно
- Достаточно ресурсов для обработки файлов

---

## 9. Критерии приемки

### 9.1 Функциональные критерии
- ✅ Все модули успешно импортируются
- ✅ Классификация документов работает корректно
- ✅ Извлечение текста из всех поддерживаемых форматов
- ✅ ИИ-анализ возвращает структурированные данные
- ✅ Интеграция с Bitrix24 функционирует
- ✅ Демо-режим работает без API ключей

### 9.2 Технические критерии
- ✅ Покрытие тестами > 80%
- ✅ Документация актуальна
- ✅ Код соответствует стандартам PEP 8
- ✅ Обработка ошибок реализована
- ✅ Логирование настроено

---

## 10. Риски и митигация

### 10.1 Технические риски
| Риск | Вероятность | Влияние | Митигация |
|------|-------------|---------|-----------|
| Изменение API OpenAI | Средняя | Высокое | Версионирование API, демо-режим |
| Проблемы с извлечением текста | Низкая | Среднее | Множественные библиотеки |
| Сбои Bitrix24 API | Средняя | Среднее | Повторные попытки, очереди |

### 10.2 Бизнес-риски
| Риск | Вероятность | Влияние | Митигация |
|------|-------------|---------|-----------|
| Изменение требований | Высокая | Среднее | Модульная архитектура |
| Превышение бюджета API | Средняя | Высокое | Мониторинг использования |

---

## 11. План развития

### 11.1 Версия 1.1 (Планируемая)
- Поддержка дополнительных форматов (RTF, ODT)
- Улучшенная классификация с использованием ML
- Web-интерфейс для мониторинга

### 11.2 Версия 2.0 (Планируемая)
- Поддержка множественных CRM систем
- Распознавание изображений в документах
- Аналитическая панель

---

## 12. Заключение

Проект Contract Parser Extended представляет собой комплексное решение для автоматизации обработки документов с использованием современных технологий ИИ и интеграции с CRM системами. Система спроектирована с учетом масштабируемости, надежности и простоты использования.

**Статус реализации**: ✅ **ГОТОВ К ПРОДАКШЕНУ**

Все основные требования реализованы, система протестирована и готова к развертыванию в производственной среде.